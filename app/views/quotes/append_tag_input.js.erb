tags_container = $(".quote.q-<%= @quote.id %>").find('.quote-tags');
tags_container.append("<%= escape_javascript(render :partial => 'quotes/tag_input', locals: { quote: @quote, tags: @unused_tags }) %>");

// Interface details for the appended tag input
tag_input = tags_container.find('input.new-tag');
tag_input.val('#');
tag_input.focus();


// INTERACTION EVENTS:

/*
	Turn the (+) button into a close button that removes the
	tag_input and resets the button.
*/

$(window).unbind('keyup').bind('keyup', function(e) {

	// Prevent sidebar checkbox'es from toggling on Enter(13) click
	$(".sidebar-list li").unbind('click');

	// Pressing Esc should remove tag_input and reset the button
	if(e.keyCode === 27) {
		tag_input.remove();
	}

	// Pressing Enter should add the tag
	if(e.keyCode === 13) {

		// Remove # from input field, if any
		tag = tag_input.val().replace('#', '');
		
		// Necessary param for the query
        params = { 
            qid: <%= @quote.id %>,
            tag: tag
        };

        // Add the new tag
        $.ajax({
            url: "//notedapp.herokuapp.com/add/tag_locally",
            dataType: "script",
            data: jQuery.param(params)
        });
	}
});

$(window).mouseup(function(e) {
    var container = tag_input;

    if (!container.is(e.target) && container.find(e.target).length === 0)
        tag_input.remove();
});

// Trigger DOMChange to assure jQuery events trigger on newly appended tag
$(document).trigger('DOMChange');